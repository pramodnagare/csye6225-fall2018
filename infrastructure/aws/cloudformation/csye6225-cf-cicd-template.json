{  
   "AWSTemplateFormatVersion":"2010-09-09",
   "Parameters":{  
      "CDbucket":{  
         "Description":"Code deploy S3 Bucket Name",
         "Type":"String"
      },
      "WBbucket":{  
         "Description":"Web application S3 Bucket Name",
         "Type":"String"
      },
      "DeploymentGroupName":{  
         "Description":"Deployment Group Name",
         "Type":"String"
      },
      "Ec2TagFilters":{  
         "Description":"EC2 Tag filter",
         "Type":"String"
      },
      "ApplicationName":{  
         "Description":"Application Name",
         "Type":"String"
      },
      "InstanceProfileName":{  
         "Description":"Instance Profile Name",
         "Type":"String"
      },
      "EC2ROLENAME":{  
         "Description":"EC2 Role Name",
         "Type":"String"
      },
      "CodeDeployServiceRoleName":{  
         "Description":"Code Deploy Service Role Name",
         "Type":"String"
      },
      "AWSACCOUNTNUMBER":{  
         "Description":"AWS User Account Number",
         "Type":"String"
      }
   },
   "Resources":{  
      "TravisUploadToS3":{  
         "Type":"AWS::IAM::ManagedPolicy",
         "Properties":{  
            "Description":"Policy for Travis to put objects in S3",
            "Path":"/",
            "PolicyDocument":{  
               "Version":"2012-10-17",
               "Statement":[  
                  {  
                     "Effect":"Allow",
                     "Action":[  
                        "s3:PutObject"
                     ],
                     "Resource":[  
                        {  
                           "Fn::Join":["",
                              [  
                                 "\"arn:aws:s3:::",
                                 {"Ref":"CDbucket"},
                                 "\""
                              ]
                           ]
                        },
                        {
							"Fn::Join":["",
                              [  
                                 "\"arn:aws:s3:::",
                                 {"Ref":"WBbucket"},
                                 "\""
                              ]
                           ]
						
						}
                     ]
                  }
               ]
            },
            "Users":[  
               "travis"
            ]
         }
      },
      "TravisCodeDeploy":{  
         "Type":"AWS::IAM::ManagedPolicy",
         "Properties":{  
            "Description":"Policy for Travis to call codedeploy to initiate deployment on EC2",
            "Path":"/",
            "PolicyDocument":{  
               "Version":"2012-10-17",
               "Statement":[  
                  {  
                     "Effect":"Allow",
                     "Action":[  
                        "codedeploy:RegisterApplicationRevision",
                        "codedeploy:GetApplicationRevision"
                     ],
                     "Resource":[  
                        {  
                           "Fn::Join":["",
                              [  
                                 "\"arn:aws:codedeploy:us-east-1:", 
								  {  
									 "Ref":"AWSACCOUNTNUMBER"
								  },
								  ":application:",
								  {  
									 "Ref":"ApplicationName"
								  },
                                 "\""
                              ]
                           ]
                        }
                     ]
                  },
                  {  
                     "Effect":"Allow",
                     "Action":[  
                        "codedeploy:CreateDeployment",
                        "codedeploy:GetDeployment"
                     ],
                     "Resource":[  
                        "*"
                     ]
                  },
                  {  
                     "Effect":"Allow",
                     "Action":[  
                        "codedeploy:GetDeploymentConfig"
                     ],
                     "Resource":[  
                        {  
                           "Fn::Join":["",
                              [  
                                 "\"arn:aws:codedeploy:us-east-1:",
								  {  
									 "Ref":"AWSACCOUNTNUMBER"
								  },
								  "deploymentconfig:CodeDeployDefault.OneAtATime\""
                              ]
                           ]
                        },
						{  
                           "Fn::Join":["",
                              [  
                                 "\"arn:aws:codedeploy:us-east-1:",
								  {  
									 "Ref":"AWSACCOUNTNUMBER"
								  },
								  "deploymentconfig:CodeDeployDefault.HalfAtATime\""
                              ]
                           ]
                        },
						{  
                           "Fn::Join":["",
                              [  
                                 "\"arn:aws:codedeploy:us-east-1:",
								  {  
									 "Ref":"AWSACCOUNTNUMBER"
								  },
								  "deploymentconfig:CodeDeployDefault.AllAtOnce\""
                              ]
                           ]
                        }
                     ]
                  }
               ]
            },
            "Users":[  
               "travis"
            ]
         }
      },
		
      "ec2role":{  
         "Type":"AWS::IAM::Role",
         "Properties":{  
            "RoleName":{  
               "Ref":"EC2ROLENAME"
            },
            "AssumeRolePolicyDocument":{  
               "Version":"2012-10-17",
               "Statement":[  
                  {  
                     "Effect":"Allow",
                     "Principal":{  
                        "Service":[  
                           "ec2.amazonaws.com"
                        ]
                     },
                     "Action":[  
                        "sts:AssumeRole"
                     ]
                  }
               ]
            },
            "Path":"/",
            "Policies":[  
               {  
                  "PolicyName":"Codedeploy-EC2-S3",
                  "PolicyDocument":{  
                     "Version":"2012-10-17",
                     "Statement":[  
                        {  
                           "Action":[  
                              "s3:Get*",
                              "s3:Put*",
							  "s3:Delete*"
                           ],
                           "Effect":"Allow",
                           "Resource":[  
							{  
							   "Fn::Join":["",
								  [  
									 "\"arn:aws:s3:::",
									 {"Ref":"CDbucket"},
									 "\""
								  ]
							   ]
							},
							{
								"Fn::Join":["",
								  [  
									 "\"arn:aws:s3:::",
									 {"Ref":"WBbucket"},
									 "\""
								  ]
							   ]
							
							}
                           ]
                        }
                     ]
                  }
               }
            ]
         }
      },
      "Ec2InstanceProfile":{  
         "Type":"AWS::IAM::InstanceProfile",
         "Properties":{  
            "InstanceProfileName":{  
               "Ref":"InstanceProfileName"
            },
            "Path":"/",
            "Roles":[  
               {  
                  "Ref":"ec2role"
               }
            ]
         }
      },
	  	  
	"CodeDeployServiceRole": {
			"Type": "AWS::IAM::Role",
			"Properties": {
				"RoleName": "CodeDeployServiceRole",
				"AssumeRolePolicyDocument": {
					"Version": "2012-10-17",
					"Statement": [{
						"Effect": "Allow",
						"Principal": {
							"Service": "codedeploy.amazonaws.com"
						},
						"Action": ["sts:AssumeRole"]
					}]
				},
				"ManagedPolicyArns": ["arn:aws:iam::aws:policy/service-role/AWSCodeDeployRole"],
				"Path": "/"
			}
		},
      "CodeDeployApplication":{  
         "Type":"AWS::CodeDeploy::Application",
         "Properties":{  
            "ApplicationName":{  
               "Ref":"ApplicationName"
            }
         }
      },
      "S3bucket":{  
         "Type":"AWS::S3::Bucket",
         "Properties":{  
            "BucketName":{  
               "Ref":"CDbucket"
            }
         }
      },
      "DeploymentGroup":{  
         "Type":"AWS::CodeDeploy::DeploymentGroup",
         "Properties":{  
            "ApplicationName":{  
               "Ref":"ApplicationName"
            },
            "DeploymentGroupName":{  
               "Ref":"DeploymentGroupName"
            },
            "DeploymentStyle":{  
               "DeploymentType":"IN_PLACE",
               "DeploymentOption":"WITHOUT_TRAFFIC_CONTROL"
            },
            "Ec2TagFilters":[  
               {  
                  "Key":"Name",
                  "Type":"KEY_AND_VALUE",
                  "Value":{  
                     "Ref":"Ec2TagFilters"
                  }
               }
            ],
            "ServiceRoleArn":{  
               "Fn::GetAtt":[  
                  "CodeDeployServiceRole",
                  "Arn"
               ]
            }
         }
      }
   }
}
